name: Release Charts

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'charts/**/README.md'
      - 'LICENSE'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Publish Helm chart
        uses: stefanprodan/helm-gh-pages@master
        with:
          helm_version: 3.7.2
          token: ${{ secrets.GITHUB_TOKEN }}
          charts_dir: charts
          charts_url: https://l4gdev.github.io/helm-charts/
          branch: gh-pages
          target_dir: charts
          index_dir: .

      - name: Add Artifact Hub repository metadata
        run: |
          # Save file from main branch before switching
          cp artifacthub-repo.yml /tmp/artifacthub-repo.yml

          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git fetch origin gh-pages
          git checkout gh-pages

          # Copy the file from temp location
          cp /tmp/artifacthub-repo.yml ./artifacthub-repo.yml

          git add artifacthub-repo.yml
          git diff --staged --quiet || git commit -m "Update Artifact Hub repository metadata"
          git push origin gh-pages
