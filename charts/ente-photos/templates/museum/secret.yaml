{{- if not .Values.credentials.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "ente-photos.credentials.secretName" . }}
  labels:
    {{- include "ente-photos.museum.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
type: Opaque
stringData:
  {{- if not .Values.externalDatabase.existingSecret.enabled }}
  db-password: {{ required "externalDatabase.password is required" .Values.externalDatabase.password | quote }}
  {{- end }}
  credentials.yaml: |
    # Ente Credentials Configuration
    # This file contains sensitive credentials

    # Database credentials (if not using environment variables)
    db:
      user: {{ include "ente-photos.postgresql.username" . | quote }}
      # Password is injected via environment variable ENTE_DB_PASSWORD

    # S3 Object Storage Configuration
    s3:
      {{- with .Values.credentials.s3.primary }}
      {{- if .key }}
      # Primary storage bucket
      {{ $.Values.credentials.s3.primaryBucketName | default "b2-eu-cen" }}:
        key: {{ .key | quote }}
        secret: {{ .secret | quote }}
        endpoint: {{ .endpoint | quote }}
        region: {{ .region | quote }}
        bucket: {{ .bucket | quote }}
        {{- if .areLocalBuckets }}
        are_local_buckets: {{ .areLocalBuckets }}
        {{- end }}
      {{- end }}
      {{- end }}

      {{- with .Values.credentials.s3.derived }}
      {{- if and .enabled .key }}
      # Derived storage bucket (thumbnails, etc.)
      {{ $.Values.credentials.s3.derivedBucketName | default "wasabi-eu-central-2-derived" }}:
        key: {{ .key | quote }}
        secret: {{ .secret | quote }}
        endpoint: {{ .endpoint | quote }}
        region: {{ .region | quote }}
        bucket: {{ .bucket | quote }}
      {{- end }}
      {{- end }}

      {{- range $name, $config := .Values.credentials.s3.additional }}
      {{- if $config.key }}
      # Additional bucket: {{ $name }}
      {{ $name }}:
        key: {{ $config.key | quote }}
        secret: {{ $config.secret | quote }}
        endpoint: {{ $config.endpoint | quote }}
        region: {{ $config.region | quote }}
        bucket: {{ $config.bucket | quote }}
      {{- end }}
      {{- end }}

    # Encryption Keys
    # IMPORTANT: Ente requires base64-encoded keys (NOT hex!)
    # key.encryption: 32 random bytes, standard base64
    # key.hash: 64 random bytes, standard base64
    key:
      {{- if .Values.credentials.encryption.key }}
      encryption: {{ .Values.credentials.encryption.key | quote }}
      {{- else }}
      # Auto-generated: 32 random bytes, standard base64 (randBytes already outputs base64)
      encryption: {{ randBytes 32 | quote }}
      {{- end }}
      {{- if .Values.credentials.encryption.hash }}
      hash: {{ .Values.credentials.encryption.hash | quote }}
      {{- else }}
      # Auto-generated: 64 random bytes, standard base64 (randBytes already outputs base64)
      hash: {{ randBytes 64 | quote }}
      {{- end }}

    # JWT Configuration
    # IMPORTANT: Ente requires standard base64-encoded secret (NOT hex, NOT URL-safe!)
    # jwt.secret: 32 random bytes, standard base64
    jwt:
      {{- if .Values.credentials.jwt.secret }}
      secret: {{ .Values.credentials.jwt.secret | quote }}
      {{- else }}
      # Auto-generated: 32 random bytes, standard base64 (randBytes already outputs base64)
      secret: {{ randBytes 32 | quote }}
      {{- end }}

    {{- with .Values.credentials.smtp }}
    {{- if .enabled }}
    # SMTP Configuration
    smtp:
      host: {{ .host | quote }}
      port: {{ .port }}
      username: {{ .username | quote }}
      password: {{ .password | quote }}
      email: {{ .from | quote }}
    {{- end }}
    {{- end }}

    {{- with .Values.credentials.transmail }}
    {{- if .enabled }}
    # Transmail (Zoho Zeptomail) Configuration
    transmail:
      key: {{ .key | quote }}
    {{- end }}
    {{- end }}

    {{- with .Values.credentials.stripe }}
    {{- if .enabled }}
    # Stripe Configuration
    stripe:
      {{- if .path }}
      path: {{ .path | quote }}
      {{- end }}
      {{- with .us }}
      {{- if .key }}
      us:
        key: {{ .key | quote }}
        secret: {{ .secret | quote }}
        webhook-secret: {{ .webhookSecret | quote }}
      {{- end }}
      {{- end }}
      {{- with .in }}
      {{- if .key }}
      in:
        key: {{ .key | quote }}
        secret: {{ .secret | quote }}
        webhook-secret: {{ .webhookSecret | quote }}
      {{- end }}
      {{- end }}
    {{- end }}
    {{- end }}

    {{- with .Values.credentials.apple }}
    {{- if .sharedSecret }}
    # Apple IAP Configuration
    apple:
      shared-secret: {{ .sharedSecret | quote }}
    {{- end }}
    {{- end }}

    {{- with .Values.credentials.discord }}
    {{- if .botToken }}
    # Discord Notifications Configuration
    discord:
      bot-token: {{ .botToken | quote }}
      {{- if .channelId }}
      channel-id: {{ .channelId | quote }}
      {{- end }}
    {{- end }}
    {{- end }}

    {{- if .Values.credentials.extraCredentials }}
    # Additional Credentials
    {{- .Values.credentials.extraCredentials | nindent 4 }}
    {{- end }}
{{- end }}
