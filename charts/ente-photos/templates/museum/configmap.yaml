apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ente-photos.museum.configMapName" . }}
  labels:
    {{- include "ente-photos.museum.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  museum.yaml: |
    # Ente Museum Server Configuration
    # Sensitive credentials are in credentials.yaml (mounted as secret)

    # HTTP Server Configuration
    http:
      port: {{ .Values.museum.config.http.port | default 8080 }}
      {{- if .Values.museum.config.http.useTls }}
      use-tls: true
      {{- end }}

    # Database Configuration (credentials via environment variables)
    db:
      host: {{ include "ente-photos.postgresql.host" . }}
      port: {{ include "ente-photos.postgresql.port" . }}
      name: {{ include "ente-photos.postgresql.database" . }}
      {{- with .Values.museum.config.db }}
      {{- if .sslmode }}
      sslmode: {{ .sslmode }}
      {{- end }}
      {{- if .maxOpenConns }}
      max-open-conns: {{ .maxOpenConns }}
      {{- end }}
      {{- if .maxIdleConns }}
      max-idle-conns: {{ .maxIdleConns }}
      {{- end }}
      {{- end }}

    # Application Endpoints
    {{- with .Values.museum.config.apps }}
    apps:
      {{- if .publicAlbums }}
      public-albums: {{ .publicAlbums | quote }}
      {{- end }}
      {{- if .embedAlbums }}
      embed-albums: {{ .embedAlbums | quote }}
      {{- end }}
      {{- if .publicLocker }}
      public-locker: {{ .publicLocker | quote }}
      {{- end }}
      {{- if .cast }}
      cast: {{ .cast | quote }}
      {{- end }}
      {{- if .accounts }}
      accounts: {{ .accounts | quote }}
      {{- end }}
      {{- if .family }}
      family: {{ .family | quote }}
      {{- end }}
      {{- if .cname }}
      cname: {{ .cname | quote }}
      {{- end }}
    {{- end }}

    # Internal Settings
    internal:
      {{- with .Values.museum.config.internal }}
      {{- if .silent }}
      silent: {{ .silent }}
      {{- end }}
      {{- if .admins }}
      admins:
        {{- range .admins }}
        - {{ . }}
        {{- end }}
      {{- end }}
      {{- if .disableRegistration }}
      disable-registration: {{ .disableRegistration }}
      {{- end }}
      {{- if .hardcodedOtt }}
      hardcoded-ott:
        {{- toYaml .hardcodedOtt | nindent 8 }}
      {{- end }}
      {{- end }}

    # Replication Configuration
    {{- with .Values.museum.config.replication }}
    {{- if .enabled }}
    replication:
      enabled: {{ .enabled }}
      {{- if .workers }}
      workers: {{ .workers }}
      {{- end }}
    {{- end }}
    {{- end }}

    # Background Jobs
    {{- with .Values.museum.config.jobs }}
    jobs:
      {{- if .cron }}
      cron:
        {{- if .cron.skip }}
        skip: {{ .cron.skip }}
        {{- end }}
      {{- end }}
    {{- end }}

    # WebAuthn Configuration (for passkeys)
    {{- with .Values.museum.config.webauthn }}
    {{- if .enabled }}
    webauthn:
      rpid: {{ .rpid | quote }}
      {{- if .rporigins }}
      rporigins:
        {{- range .rporigins }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- end }}

    # Clear Orphan Objects Configuration
    {{- with .Values.museum.config.clearOrphanObjects }}
    {{- if .enabled }}
    clear-orphan-objects:
      enabled: {{ .enabled }}
      {{- if .prefix }}
      prefix: {{ .prefix | quote }}
      {{- end }}
    {{- end }}
    {{- end }}

    # S3 Storage Configuration
    {{- if or .Values.museum.config.s3 .Values.credentials.s3.primaryBucketName }}
    s3:
      {{- with .Values.museum.config.s3 }}
      {{- if .areLocalBuckets }}
      are_local_buckets: {{ .areLocalBuckets }}
      {{- end }}
      {{- if .usePathStyleUrls }}
      use_path_style_urls: {{ .usePathStyleUrls }}
      {{- end }}
      {{- end }}
      # Map default bucket name (b2-eu-cen) to our bucket identifier
      b2-eu-cen: {{ .Values.credentials.s3.primaryBucketName | default "b2-eu-cen" | quote }}
    {{- end }}

    {{- if .Values.museum.config.extraConfig }}
    # Additional Configuration
    {{- .Values.museum.config.extraConfig | nindent 4 }}
    {{- end }}
